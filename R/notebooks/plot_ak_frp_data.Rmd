---
title: ## "FRP burn data plots"
author: "JWalker"
date: "2018-07-27"
output:
  html_notebook:
    highlight: tango
    mathjax: null
    number_sections: no
    theme: spacelab
---
```{r, echo=FALSE, warning=FALSE, include=FALSE}
########################################################################### #
#
# plot_ak_frp_data.R 
#
# Objective:  Plot processed MxD14A1 FRP data.
#
# Input:     .RData file produced by process_ak_frp_data.R
#
# Output:     Box-plots of FRP by burn frequency (1x, 2x, 3x burns)
#             
#   
#   JWalker 17 April 2018
#  
########################################################################### #

# ---- Set environment ----

# Remove existing data and values
rm(list=ls())

# Load libraries
library(ggplot2)
library(lubridate)
library(dplyr)

# Set folder paths
path.in <- "D:/projects/ak_fire" 
path.plots <- "D:/projects/ak_fire/output/plots/frp"

# Load functions
source(file.path(path.in, "R", "ak_functions.R"))

# Load data saved from 'process_ak_frp_data.R'
rdata <- "ak_frp_data.RData"
load(file = file.path(path.in, "data", rdata))

# Set consistent plot parameters
dodge = position_dodge(0.16)
theme_set(theme_bw())
plot_opts <- theme(panel.grid.minor.x = element_blank(),
                   panel.grid.major.x = element_blank(), # hide gridlines
                   legend.key = element_blank(),  # remove boxes around legend items
                   plot.title = element_text(hjust = 0.5)) # center title
```
### Plots related to the analysis of FRP data in Alaskan fires
<br>


Given the wide range of FRP values, log(FRP) plots are more decipherable. Relative patterns are consistent, however, as the comparison below shows.  

Non-log plot of FRP vs. all year and all land cover type:

```{r, echo=FALSE, eval=TRUE}
title <- "FRP by burn number, all years, combined land cover"
plot.name <- "AK_FRP by burn number_all years.png"

# Get means
means <- aggregate(MaxFRP ~ burn_num, x, mean)

# Plot boxplot with mean values 
p <- ggplot(x, aes(as.factor(burn_num), MaxFRP)) + 
            geom_boxplot(aes(fill = as.factor(burn_num)), show.legend = F) +
            geom_point(data=x.frp.summary, aes(as.factor(burn_num), mean, shape = "mean"), size = 7) +
            scale_shape_manual("", values = 18) +
            geom_text(data = means, aes(label = round(MaxFRP, 2), y = MaxFRP + 16), 
                      hjust = -0.4, vjust = 0.3) +
            coord_cartesian(ylim = c(0,500), expand = TRUE) +
            labs(x = "Burn number", y = "FRP") +
           ggtitle(title)
 p + plot_opts

# ggsave(filename = plot.name, path = path.plots, width = 10, height = 7, units = c("in"), dpi = 600)

```
Same data in log format:
```{r, echo = FALSE, eval=TRUE}

# ------- BOXPLOT by burn number, log plot

title <- "Log FRP by burn number, all years, combined land cover"
plot.name <- "AK_FRP by burn number_all years_log.png"


# Plot boxplot with mean values 
p <- ggplot(x, aes(as.factor(burn_num), log10(MaxFRP))) + 
  geom_boxplot(aes(fill = as.factor(burn_num)), show.legend = F) +
  geom_point(data=means, aes(as.factor(burn_num), log10(MaxFRP), shape = "mean"), size = 7) +
  scale_shape_manual("", values = 18) +
  geom_text(data = means, aes(label = round(log10(MaxFRP), 2), y = log10(MaxFRP) + 0.1), 
            hjust = -0.4, vjust = 0.1) +
  labs(x = "Burn number", y = "log FRP") +
  ggtitle(title)
p + plot_opts

ggsave(filename = plot.name, path = path.plots, width = 10, height = 7, units = c("in"), dpi = 600)


```
The above plot is not too helpful because FRP is evaluated across all land cover types.  Below is the same data broken out by land cover, where "land cover" is whichever EVT class covered the greatest proportion of each 1-km MODIS pixel.
```{r, echo=FALSE, eval=TRUE}

#--------- BOXPLOT by max vegetation classes

title <- "Log FRP by maximum vegetation classburn number, all years"
plot.name <- "AK_FRP by burn number_all years_log.png"
p <- ggplot(subset(x, (evt_group %in% x.maxevt.gp.top$evt_group)), aes(burn_num, log10(MaxFRP))) + 
      geom_boxplot() + 
    labs(x = "Burn number", y = "log FRP") +
      facet_wrap( ~ evt_group, ncol = 3) #+ 
#      coord_cartesian(ylim = c(0, 800), expand = TRUE)
p + plot_opts

```
Influence of number of years since prior burn on FRP, by individual EVT class.

Birch/Aspen
```{r}
  
title <- "Mean FRP by # of years since prior burn"

# -------- PLOT by mean fire interval
  x.sub <- subset(x, evt_group == "BirchAspen" & year_int != 0)
  x.summary <- x.sub %>% group_by(year_int) %>% summarize(mean = mean(MaxFRP))

  y.max <- max(x.summary$mean)
  
  p <- ggplot(x.summary, aes(year_int, mean)) + 
       geom_point() + 
       geom_smooth(method = 'lm', se = FALSE, size = 0.4) +
       labs(x = "Years since prior burn", y = "FRP") +
       annotate("text", x = 5, y = 0.9*y.max, label = lm_eqn(x.summary, "mean", "year_int"), 
           parse = TRUE, hjust = 0, vjust = 0, color = "#000000") +
       ggtitle(title)
  p + plot_opts


```
Black Spruce
```{r}
  
# -------- PLOT by mean fire interval

  x.sub <- subset(x, evt_group == "BlkSpruce" & year_int != 0)
  x.summary <- x.sub %>% group_by(year_int) %>% summarize(mean = mean(MaxFRP))

  y.max <- max(x.summary$mean)

  p <- ggplot(x.summary, aes(year_int, mean)) + 
       geom_point() + 
       geom_smooth(method = 'lm', se = FALSE, size = 0.4) +
       labs(x = "Years since prior burn", y = "FRP") +
       annotate("text", x = 2, y = 0.9*y.max, label = lm_eqn(x.summary, "mean", "year_int"), 
           parse = TRUE, hjust = 0, vjust = 0, color = "#000000") +
       ggtitle(title)
  p + plot_opts


```
Burned
```{r}
  
# -------- PLOT by mean fire interval

  x.sub <- subset(x, evt_group == "BlkSpruce" & year_int != 0)
  x.summary <- x.sub %>% group_by(year_int) %>% summarize(mean = mean(MaxFRP))

  y.max <- max(x.summary$mean)

  p <- ggplot(x.summary, aes(year_int, mean)) + 
       geom_point() + 
       geom_smooth(method = 'lm', se = FALSE, size = 0.4) +
       labs(x = "Years since prior burn", y = "FRP") +
       annotate("text", x = 2, y = 0.9*y.max, label = lm_eqn(x.summary, "mean", "year_int"), 
           parse = TRUE, hjust = 0, vjust = 0, color = "#000000") +
       ggtitle(title)
  p + plot_opts

```
Floodplain
```{r}
  
# -------- PLOT by mean fire interval

  x.sub <- subset(x, evt_group == "BlkSpruce" & year_int != 0)
  x.summary <- x.sub %>% group_by(year_int) %>% summarize(mean = mean(MaxFRP))

  y.max <- max(x.summary$mean)

  p <- ggplot(x.summary, aes(year_int, mean)) + 
       geom_point() + 
       geom_smooth(method = 'lm', se = FALSE, size = 0.4) +
       labs(x = "Years since prior burn", y = "FRP") +
       annotate("text", x = 2, y = 0.9*y.max, label = lm_eqn(x.summary, "mean", "year_int"), 
           parse = TRUE, hjust = 0, vjust = 0, color = "#000000") +
       ggtitle(title)
  p + plot_opts


```
Grassland
```{r}
  
# -------- PLOT by mean fire interval

  x.sub <- subset(x, evt_group == "BlkSpruce" & year_int != 0)
  x.summary <- x.sub %>% group_by(year_int) %>% summarize(mean = mean(MaxFRP))

  y.max <- max(x.summary$mean)

  p <- ggplot(x.summary, aes(year_int, mean)) + 
       geom_point() + 
       geom_smooth(method = 'lm', se = FALSE, size = 0.4) +
       labs(x = "Years since prior burn", y = "FRP") +
       annotate("text", x = 2, y = 0.9*y.max, label = lm_eqn(x.summary, "mean", "year_int"), 
           parse = TRUE, hjust = 0, vjust = 0, color = "#000000") +
       ggtitle(title)
  p + plot_opts


```

 Peatland
```{r}
  
# -------- PLOT by mean fire interval

  x.sub <- subset(x, evt_group == "BlkSpruce" & year_int != 0)
  x.summary <- x.sub %>% group_by(year_int) %>% summarize(mean = mean(MaxFRP))

  y.max <- max(x.summary$mean)

  p <- ggplot(x.summary, aes(year_int, mean)) + 
       geom_point() + 
       geom_smooth(method = 'lm', se = FALSE, size = 0.4) +
       labs(x = "Years since prior burn", y = "FRP") +
       annotate("text", x = 2, y = 0.9*y.max, label = lm_eqn(x.summary, "mean", "year_int"), 
           parse = TRUE, hjust = 0, vjust = 0, color = "#000000") +
       ggtitle(title)
  p + plot_opts

```
 Shrubland
```{r}
  
  
# -------- PLOT by mean fire interval

  x.sub <- subset(x, evt_group == "BlkSpruce" & year_int != 0)
  x.summary <- x.sub %>% group_by(year_int) %>% summarize(mean = mean(MaxFRP))

  y.max <- max(x.summary$mean)

  p <- ggplot(x.summary, aes(year_int, mean)) + 
       geom_point() + 
       geom_smooth(method = 'lm', se = FALSE, size = 0.4) +
       labs(x = "Years since prior burn", y = "FRP") +
       annotate("text", x = 2, y = 0.9*y.max, label = lm_eqn(x.summary, "mean", "year_int"), 
           parse = TRUE, hjust = 0, vjust = 0, color = "#000000") +
       ggtitle(title)
  p + plot_opts


```
Swamp 
```{r}
  
  
# -------- PLOT by mean fire interval

  x.sub <- subset(x, evt_group == "Swamp" & year_int != 0)
  x.summary <- x.sub %>% group_by(year_int) %>% summarize(mean = mean(MaxFRP))

  y.max <- max(x.summary$mean)

  p <- ggplot(x.summary, aes(year_int, mean)) + 
       geom_point() + 
       geom_smooth(method = 'lm', se = FALSE, size = 0.4) +
       labs(x = "Years since prior burn", y = "FRP") +
       annotate("text", x = 30, y = 0.9*y.max, label = lm_eqn(x.summary, "mean", "year_int"), 
           parse = TRUE, hjust = 0, vjust = 0, color = "#000000") +
       ggtitle(title)
  p + plot_opts

```
Tundra 
```{r}
  
  
# -------- PLOT by mean fire interval

  x.sub <- subset(x, evt_group == "Tundra" & year_int != 0)
  x.summary <- x.sub %>% group_by(year_int) %>% summarize(mean = mean(MaxFRP))

  y.max <- max(x.summary$mean)

  p <- ggplot(x.pts, aes(year_int, mean)) + 
       geom_point() + 
       geom_smooth(method = 'lm', se = FALSE, size = 0.4) +
       labs(x = "Years since prior burn", y = "FRP") +
       annotate("text", x = 2, y = 0.9*y.max, label = lm_eqn(x.pts, "mean", "year_int"), 
           parse = TRUE, hjust = 0, vjust = 0, color = "#000000") +
       ggtitle(title)
  p + plot_opts


```
Wetland 
```{r}
  
  
# -------- PLOT by mean fire interval

  x.sub <- subset(x, evt_group == "BlkSpruce" & year_int != 0)
  x.summary <- x.sub %>% group_by(year_int) %>% summarize(mean = mean(MaxFRP))

  y.max <- max(x.summary$mean)

  p <- ggplot(x.pts, aes(year_int, mean)) + 
       geom_point() + 
       geom_smooth(method = 'lm', se = FALSE, size = 0.4) +
       labs(x = "Years since prior burn", y = "FRP") +
       annotate("text", x = 2, y = 0.9*y.max, label = lm_eqn(x.pts, "mean", "year_int"), 
           parse = TRUE, hjust = 0, vjust = 0, color = "#000000") +
       ggtitle(title)
  p + plot_opts

```

WhtSpruce

Has a nutty outlier
```{r}
  
  
# -------- PLOT by mean fire interval

  x.sub <- subset(x, evt_group == "BlkSpruce" & year_int != 0)
  x.summary <- x.sub %>% group_by(year_int) %>% summarize(mean = mean(MaxFRP))

  y.max <- max(x.summary$mean)

  p <- ggplot(x.pts, aes(year_int, mean)) + 
       geom_point() + 
       geom_smooth(method = 'lm', se = FALSE, size = 0.4) +
       labs(x = "Years since prior burn", y = "FRP") +
       annotate("text", x = 2, y = 0.9*y.max, label = lm_eqn(x.pts, "mean", "year_int"), 
           parse = TRUE, hjust = 0, vjust = 0, color = "#000000") +
       ggtitle(title)
  p + plot_opts


```





```{r, echo=FALSE}

# -------- HISTOGRAM of distributions

p <- ggplot(x, aes(x=log10(MaxFRP), fill = burn_num)) + 
      geom_histogram(alpha = 0.5, position = "identity",
      binwidth = 0.1) +
      xlab("log FRP")

p + plot_opts

```



```{r, echo=FALSE}

x.yr <- x

# ------ PLOT by years since prior burn
# Drop factors for which there are fewer than 10 points
  keep <- levels(as.factor(x$year_int))[table(x$year_int) > 10]

  title <- "FRP by years since prior burn"
  p <- ggplot(x, aes(as.factor(year_int), log10(MaxFRP))) + 
       geom_boxplot() + 
       #ylim(0, 1000) + 
       labs(x = "Years since prior burn", y = "log FRP") +
       ggtitle(title)
  p + plot_opts

  #ggsave(filename = plot.name, path = path.plots, width = 10, height = 7, units = c("in"), dpi = 600)

```

Slight upward trend in 
```{r, eval = FALSE, echo=FALSE}
  
# -------- PLOT by mean fire interval
  x.pts <- x %>% group_by(year_int) %>% summarize(mean = mean(MaxFRP))

#  title <- paste0("Mean FRP by year interval, ", yr)
#  plot.name <- paste0("AK_FRP mean FRP by year ", yr, ".png")

  p <- ggplot(x.pts, aes(year_int, mean)) + 
       geom_point() + 
       geom_smooth(method = 'lm', se = FALSE, size = 0.4) +
       labs(x = "Years since prior burn", y = "FRP") +
       annotate("text", x = 5, y = 400, label = lm_eqn(x.pts, "mean", "year_int"), 
           parse = TRUE, hjust = 0, vjust = 0, color = "#000000") +
       ggtitle(title)
  p + plot_opts

#ggsave(filename = plot.name, path = path.plots, width = 10, height = 7, units = c("in"), dpi = 600)
```




```{r}

# Calculate semivariograms
x.copy <- x.yr

# convert degrees to km distances
x.copy$lon_km <- 110. * (x.copy$longitude - (-125))*cos(x.copy$latitude/(360/(2*pi)))
x.copy$lat_km <- 110. * (x.copy$latitude-65)
coordinates(x.copy) = ~lon_km+lat_km


# ------- PLOT points in x,y km space  
plot.name <- paste0("AK_FRP bubble plot ", yr, ".png")
png(file = file.path(path.plots, plot.name), width = 10, height = 7, units = c("in"), res = 600)
print(bubble(x.copy, zcol = 'MaxFRP', fill = T, do.sqrt = F, maxsize = 1.8))
dev.off()

# ------- PLOT variogram
v = variogram(MaxFRP~1, x.copy)
level <- c(0.5, 0.95)

plot.name <- paste0("AK_FRP variogram ", yr, ".png")
png(file = file.path(path.plots, plot.name), width = 10, height = 7, units = c("in"), res = 600)
print(plot(v, fraction = 0.65, level=level))
dev.off()


# # ------PLOT directional variogram
#   v.fit = fit.variogram(v, vgm("Sph"))
#   x.copy.var.det <- variogram(MaxFRP~lat_km+lon_km, data = x.copy)
#   
#   plot.name <- paste0("AK_FRP directional variogram ", yr, ".png")
#   p <- plot(x.copy.var.det)
#   p

plot.name <- paste0("AK_FRP directional variogram ", yr, ".png")

x.copy.var.dir <- variogram(MaxFRP~1, data = x.copy, alpha = c(0, 45, 90, 135))
#png(file = file.path(path.plots, plot.name), width = 10, height = 7, units = c("in"), res = 600)
print(plot(x.copy.var.dir))
dev.off()

}
```


