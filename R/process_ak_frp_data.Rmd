---
title:  "Process AK FRP data"
author: "JJWalker"
date: "2016-08-01"
output:
  html_notebook:
    highlight: tango
    mathjax: null
    number_sections: no
    theme: spacelab
---


####process_ak_frp_data.Rmd 

This script inputs annual MxD14A1 FRP datasets produced in GEE and outputs an Rdata file for further plotting and analysis. Prior to input, FRP files are processed as follows:   

  * Formatted from GEE format to ArcMap-ready (_format_gee_file_for_import_into_arc.R_)
  * Intersected with the BLM fire history vector file (_intersect_frp_data_with_fire_perimeters.py_) to combine 
    * FRP data
    * EVT data (in the coincident MODIS 1-km pixel)
    * Fire history information
    
Input files: mxda1_gee_<yyyy>_plus_fire_info.csv, where <yyyy> = 2002-2016

Output file: ak_frp_area_data.RData. 


```{r, echo = FALSE}

# ---------------------------------------------------------------- #
#### Set up ####
# ---------------------------------------------------------------- #

# Remove existing data and libraries from R environment
#rm(list=ls()) # bad, bad!

# Load libraries
library(lubridate) 
library(tidyverse)
library(dtplyr)
library(kableExtra) #kable tables
library(knitr) #kable

# Set paths
#path.in <- "D:/projects/ak_fire"
path.in = "/Users/jessicawalker/Documents/projects/ak_frp"
#path.r <- "D:/projects/ak_fire/data"
path.r <- file.path(path.in, "data")
rdata <- "ak_frp_data_pixel_area.RData"
#path.plots <- "D:/projects/ak_fire/output/plots/frp"
path.plots <- file.path(path.in, "output/plots")

source(file.path(path.in, "R", "ak_functions.R"))

```


```{r, echo = F}

# ---------------------------------------------------------------- #
#### Combine annual files ####
# ---------------------------------------------------------------- #

# if the data are already saved in an Rdata file, skip this part
#if (file.exists(file.path(path.r, rdata))){
#   load(file.path(path.r, rdata))
# } else {

# Get the relevant filenames
  filenames.in <- list.files(file.path(path.in, "data/intersected"), pattern = "*plus_fire_info_bufferIn600m.csv")
  
# Read all files to a single file. Suppress warnings b/c of spurious "incomplete last line" error
  suppressWarnings(x.all <- do.call(rbind, lapply(file.path(path.in, "data/intersected", filenames.in),   read.csv,row.names=NULL)))

```

```{r, echo = F}

# ---------------------------------------------------------------- #
#### Define columns ####
# ---------------------------------------------------------------- #

# Retain only specified columns
  colNames <- c("index",
  "class11", "class12", "class21", "class2197", "class22", "class23", "class24",     
  "class2600", "class2601", "class2602", "class2603", "class2604", "class2605", "class2606", "class2607", "class2608", "class2609", 
  "class2610", "class2611", "class2612",
  "class2631", "class2633", "class2634", "class2635", "class2636", "class2638", "class2639", 
  "class2640", "class2642", "class2643", "class2644", "class2645", "class2646", "class2648", "class2649", 
  "class2651", "class2652", 
  "class2671", "class2677", "class2678", "class2679", 
  "class2682", "class2683", "class2684", "class2685", "class2686", "class2687", "class2688", "class2689", 
  "class2690", "class2691", "class2692", "class2699", 
  "class2709", "class2718", "class2719", 
  "class2720",
  "class2730", 
  "class2740", "class2741", "class2742", "class2743", "class2744", "class2745", "class2746", "class2747",
  "class2751", "class2753", "class2756", "class2757", "class2758",     
  "class2761", "class2762", "class2763", "class2764", 
  "class2771", "class2772", "class2773", "class2774", "class2776", "class2777", 
  "class2781", "class2782", "class2783", "class2784", "class2785", "class2786",     
  "class2791", "class2792", "class2793", "class2794", 
  "class31", 
  "class81", "class82",
  "MaxFRP", "latitude", "longitude",
  "newdate", "FireYear", "FIREID", "DiscDate")

 x <- x.all[, colNames]
 
```

###EVT class consolidation

EVT classes are combined as follows:

<>
```{r, echo = F}

# ---------------------------------------------------------------- #
#### Define EVT columns ####
# ---------------------------------------------------------------- #

# Define EVT classes and consolidated groups
  evt_classes <- data.frame(evt_number =  
                c("class11", "class12", "class21", "class2197","class22","class23", "class24",
                  "class2600", "class2601","class2602","class2603", "class2604","class2605","class2606","class260","class2608","class2609",
                  "class2610","class2611","class2612",
                  "class2631","class2633","class2634","class2635","class2636","class2638", "class2639",
                  "class2640", "class2642", "class2643", "class2644", "class2645", "class2646", "class2648", "class2649",
                  "class2651", "class2652",
                  "class2671","class2677","class2678", "class2679",
                  "class2682", "class2683", "class2684", "class2685","class2686", "class2687", "class2688", "class2689",
                  "class2690", "class2691", "class2692", "class2699",
                  "class2709", "class2718", "class2719", 
                  "class2720", 
                  "class2730",
                  "class2740","class2741", "class2742","class2743","class2744","class2745","class2746", "class2747",
                  "class2751","class2753","class2756", "class2757", "class2758",
                  "class2761", "class2762", "class2763","class2764",
                  "class2771", "class2772", "class2773", "class2774", "class2776","class2777",
                  "class2781", "class2782","class2783", "class2784", "class2785", "class2786", 
                  "class2791", "class2792", "class2793", "class2794","class31", 
                  "class81", "class82"),

  evt_group = c("Water", "Snow", "Developed", "Burned", "Developed", "Developed", "Developed",
                   "WhtSpruce", "WhtSpruce", "BlkSpruce", "WhtSpruce", "BlkSpruce", "BirchAspen", "Aspen", 
                   "BalsPopAsp", 
                   "Shrubland", "Shrubland", "Shrubland", "Grassland", "Grassland","Shrubland", 
                   "Grassland", 
                   "Shrubland", "Shrubland", "Shrubland", "Shrubland", "Shrubland", "Shrubland", 
                   "BirchAspen", "Shrubland", "Spruce", "Grassland", 
                   "Hemlock", "Hemlock", "Hemlock", 
                    "Grassland", "Shrubland", "Grassland",
                   "WhtSpruce", "WhtSpruce", "WhtSpruce", "Shrubland", 
                   "Tundra", "Tundra", "Tundra", "Tundra", "Tundra",
                   "Shrubland", "Shrubland", "Shrubland", 
                   "Tundra", "Tundra", 
                   "Grassland", "Grassland", 
                   "Shrubland", "Shrubland", "Shrubland", "Peatland", "Marsh", "Tidal",
                   "Tidal", "Wetland", "Wetland", "Wetland", "Wetland", "Grassland", "Wetland",
                   "BlkSpruce", "Shrubland", "Shrubland", "Shrubland", "Floodplain", "Floodplain", "Floodplain",
                   "Floodplain", "Peatland", "Peatland","Peatland", "Peatland", "Shrubland", "Swamp",
                   "Tundra", "Tundra","Tundra","Tundra","Tundra","Tundra","Barren", "Barren", "Barren",
                   "Barren", "Barren", "Agriculture", "Agriculture"))

```


```{r, echo = FALSE}

# ---------------------------------------------------------------- #
#### File clean up and formatting ####
# ---------------------------------------------------------------- #

# Point ID ('index') is unique to each point, though the same ID can occur in multiple rows, since
# a single point may have burned in multiple fires.Replace with sequence of sequential numbers.
  levels(x$index) <- c(seq(1:length(levels(x$index))))
  
# Rename columns
  colnames(x)[which(colnames(x) == "index")] <- "ptid"
  colnames(x)[which(colnames(x) == "MaxFRP")] <- "frp"
  colnames(x)[which(colnames(x) == "FireYear")] <- "fire_year"
  colnames(x)[which(colnames(x) == "FIREID")] <- "fireid"
  colnames(x)[which(colnames(x) == "FID")] <- "fid"

# Set FID as unique id for each row
  x$fid <- 1:nrow(x)

# Reorder s.t. FID is first
  x <- x[, c(ncol(x), 1:(ncol(x)-1))]

# Remove NA-only columns
  x <- Filter(function(y) !all(is.na(y)), x)
  
# MODIS frp is scaled by 10
  x$frp <- 0.1 * x$frp

# Remove rows in which frp == NA
  x <- x[!is.na(x$frp), ]

# Format date columns and remove old ones
  x$modis_date <- as.Date(x$newdate, format = "%m/%d/%Y")  #"%Y-%m-%d")
  x$fire_date <- as.Date(x$DiscDate, format = "%m/%d/%Y")
  x$modis_year <- year(x$modis_date)
  
# Ensure point id is a factor
  x$ptid <- factor(x$ptid)

# Remove unneeded columns
  x$DiscDate <- NULL
  x$newdate <- NULL
  
# Remove all rows in which the modis date preceeds the fire date
   x <- x[which(x$modis_date > x$fire_date), ]

# Keep a backup  
  x.backup <- x

```
###Assemble the new dataframe of fires

For each point, there has to be a row for each year a fire took place. The following rules apply:

  * Fires prior to the MODIS era are documented only through the BLM history database (i.e., FRP = NA)  
  * Fires in the MODIS era are documented through the database and/or through the presence of a FRP pixel  
    * FRP pixels without a corresponding entry in the fire history database are logged as a fire; BLM fire ID = NA. 
    * Fires in the MODIS era with a database entry but without a registered FRP value are removed

The database starts in this format (classes are removed for this exercise):

```{r, echo=FALSE, warning=F}

# ---------------------------------------------------------------- #
#### Assemble the new fire df ####
# ---------------------------------------------------------------- #

# We need a row for each unique fire_year and modis_year
# PLUS...FRP value for each MODIS year (pre-MODIS years get a holder value)
# ptid, lat, long,, evt: all the stuff that doesn't change for each point.

# we only have 1 frp per year, so we can take the corresponding frp for the modis years

# For each ptid:
# construct a new dataframe from the consistent info
# replicate for the number of years
# get the unique years for fire years and modis years

# Set up a df to hold all entries
  df.all <- setNames(data.frame(matrix(ncol = 6, nrow = 0)),  c('ptid', 'latitude', 'longitude', 'fire_year', 'frp', 'FIREID'))

# Remove classes for this exercise
  x.noclasses <- x[, -which(names(x) %in% names(x[grepl("class", names(x))]))]
  
# Create with only 1 instance of the classes associated with each ptid
  x.classes <- x[, which(names(x) %in% c('ptid', names(x[grepl("class", names(x))])))]
  x.classes <- x.classes[!duplicated(x.classes$ptid), ]

```

Example of a point with multiple associated fires

`r x.noclasses %>%
  filter(ptid == 5767) %>% 
  kable() %>%
  kable_styling()`

```{r, echo=FALSE}
# ---------------------------------------------------------------- #
#### Function to create new fire df ####
# ---------------------------------------------------------------- #

create_new_fire_df = function(f) {

  # Trim factor levels
  f$ptid <- factor(f$ptid)

  # List of all unique fire and MODIS years. 
  years <- unique(c(f$fire_year, f$modis_year))
  
  #set up a new df with the info that doesn't change
  f.new <- f[1, c("ptid", "latitude", "longitude")] %>% slice(rep(1:n(), each = length(years)))

  # Add fire years
  f.new <- cbind(f.new, fire_year = years)

  # Get the frp corresponding to the MODIS year
  # Years preceeding modis era get NA
  # 'distinct' is to catch duplicates of modis year/frp, since the same frp is registered for multiple fire years that
  # preceed the modis era
  merge1 <- left_join(f.new, distinct(dplyr::select(f, modis_year, frp)), by = c("fire_year" = "modis_year"))
     
  # Join to get fire_id, etc.
  merge2 <- merge1 %>% left_join(distinct(dplyr::select(f, fireid, fire_year), fire_year, .keep_all = T), by = c("fire_year"))
  
  # Consolidate wth holder dataframe
   df.all <- rbind(df.all, merge2)
   
   return(df.all) 
  }
```  

```{r, echo=FALSE}

# ---------------------------------------------------------------- #
#### Merge new fire df with EVT classes ####
# ---------------------------------------------------------------- #

# tidyverse application of fcn to subset
lst.all <- x.noclasses %>% 
  group_by(ptid) %>%
  do(create_new_fire_df(.))

# Convert from df of lists to just a df
x.new <- data.frame(lst.all)
x.new <- x.new[order(x.new$ptid, x.new$fire_year), ]

# Convert row numbers to numeric index in order to sort
x.new$index <- as.numeric(row.names(x.new))
x.new <- x.new[order(x.new$index), ]

```

  
```{r, echo = FALSE}

# ---------------------------------------------------------------- #
#### Function - Calculate burn number ####
# ---------------------------------------------------------------- #

# Count the number of times each point appears: 1 = first fire, 2 = 2nd, etc.
  get_fire_order = function(df) {
    df <- df %>% 
      group_by(ptid) %>% 
      arrange(fire_year) %>%  # put in ascending order
      mutate(burn_num = seq_along(fire_year)) # assign a sequence number
    df <- data.frame(df)
    df$reburn <- 0 
    df[which(as.numeric(df$burn_num) > 1), ]$reburn <- 1 # reburn: no = 0, yes = 1
    df$year_int <- ave(df$fire_year, factor(df$ptid), FUN=function(t) c(0, diff(t))) # get years between fires
  return(df)
  }

```

```{r, echo = FALSE}

# ---------------------------------------------------------------- #
#### Get burn number for each point ####
# ---------------------------------------------------------------- #

x.new <- get_fire_order(x.new)
x.new$ptid <- as.factor(x.new$ptid)
```

After removing duplicates associated with the same FRP and assigning burn numbers and intervals, the same point id has this format:

`r temp %>%
  filter(ptid == 5767) %>% 
  kable() %>%
  kable_styling()`
  
```{r, echo = FALSE}

# ---------------------------------------------------------------- #
#### Merge fire df with EVT classes ####
# ---------------------------------------------------------------- #

x.classes$ptid <- as.numeric(x.classes$ptid)
x.all <- merge(x.new, x.classes, by = c("ptid"), all.x = T)

```


```{r, echo = FALSE}

# ---------------------------------------------------------------- #
####  ####
# ---------------------------------------------------------------- #

# Plot the points
x.all %>% 
ggplot(aes(longitude, latitude)) + geom_point(color = 'red', size = 1)
```

Add the EVT classes back to the dataframe, and calculate:

1. EVT class with the greatest proportion in each 1-km MODIS pixel
2. Number of 30-m pixels of that class

Pixels in which none of the classes had a majority are removed.
```{r, echo = FALSE, warning = F}

# ---------------------------------------------------------------- #
#### Process EVT classes ####
# ---------------------------------------------------------------- #
  
  # Record the EVT class that had the greatest area in each 1-km MODIS pixel
  x.all$max_evt_cat <- apply(x.all, 1, function(y) names(y[grepl("class", names(y))])[which.max(y[grepl("class", names(y))])[1]])
  
  # ...record tharea that class represented
  x.all$max_evt_area <- apply(x.all[grepl("class", names(x.all))], 1, max, na.rm = TRUE)
  
  # ...calculate the proportion of pixels that class represented
  #x.all$max_evt_prop <- x.all$max_evt_pix/max_landsat_pixels * 100

  # Remove rows in which max_class == NA; this means none of the classes had a majority
  x.all <- x.all[!is.na(x.all$max_evt_cat), ]

  # Convert to factor
  x.all$max_evt_cat <- as.factor(x.all$max_evt_cat)

  # Merge with file of EVT classes to associate a name with each class
  x.all <- merge(x.all, evt_classes, by.x = "max_evt_cat", by.y = "evt_number")
  
  # Keep original set of data prior to excluding classes
  x.original <- x.all
  
  # Get rid of all individual classes. Keep as separate file s.t. proportions
  # can be analyzed if desired
  x.all <- x.all[, -which(names(x.all) %in% names(x.all[grepl("class", names(x.all))]))]

```
  
```{r, echo = FALSE}

# ---------------------------------------------------------------- #
#### Calculate stats ####
# ---------------------------------------------------------------- #

# Convert to factor
x.all$burn_num <- as.factor(x.all$burn_num)

# FRP by burn count (data)
x.frp.summary <- x.all %>%
                 group_by(burn_num) %>%
                 summarize(mean = mean(frp, na.rm = T),
                           med = median(frp, na.rm = T),
                           n = length(burn_num))

# > x.frp.summary
# # A tibble: 4 x 4
# `burn_num`   mean   med     n
# <fct>                 <dbl> <dbl> <int>
#   1 1                    197.  77.8 59532
# 2 2                      176.  81.4  9807
# 3 3                      176.  75.7   967
# 4 4                      132.  52.2    67

# # this works reliably...just less fun
 # x.frp2 <- ddply(x, .(burn_num), summarize,
 #                mean = mean(MaxFRP),
 #                med = median(MaxFRP))
 
# Round decimals
# means$MaxFRP <- round(means[,2], 1)

# Get # of EVT classes with majorities
x.maxevt <- summary(x$evt_group)

# Get FRP by veg class. 
# x.frp.class <- ddply(x, .(max_class, burn_num), summarize,
#                mean = mean(MaxFRP),
#                med = median(MaxFRP),
#                n = length(burn_num))

x.maxevt.gp <- x.all %>% 
                  group_by(evt_group, burn_num) %>%
                  summarize (mean = mean(frp, na.rm = T), 
                            med = median(frp, na.rm = T), 
                            n = length(burn_num))

x.maxevt.gp <- data.frame(x.maxevt.gp)
# > x.maxevt.gp
#      evt_group burn_num      mean    med     n
# 1  Agriculture        1  61.61667  41.55    24
# 2  Agriculture        2  68.20000  68.20     1
# 3        Aspen        1  72.00000  22.20     7
# 4       Barren        1 156.94000  98.70    35
# 5       Barren        2  56.60000  56.60     2
# 6   BirchAspen        1 175.08680  74.20  5947
# 7   BirchAspen        2 174.45053  73.10  1508
# 8   BirchAspen        3 199.33527  70.10   241
# 9   BirchAspen        4 205.76897  30.00    29
# 10          BS        1 232.20899  90.70 10338
# 11          BS        2 209.34827  99.50  1243
# 12          BS        3 113.83810  39.90    21
# 13          BS        4  26.80000  26.80     1
# 14      Burned        1  91.93478  47.90    23
# 15      Burned        2  70.94643  39.75    28
# 16      Burned        3  37.79231  17.90    13
# 17  Floodplain        1 144.17485  65.00  2743
# 18  Floodplain        2 150.51377  79.40   530
# 19  Floodplain        3 133.24286  65.20    21
# 20   Grassland        1 238.92504  92.40   611
# 21   Grassland        2 123.14286  68.40    49
# 22   Grassland        3 355.07500 528.40     8
# 23     Hemlock        1 394.35000 394.35     2
# 24       Marsh        1  26.90000  26.90     1
# 25    Peatland        1 112.45367  50.20   667
# 26    Peatland        2 114.57907  57.20    43
# 27   Shrubland        1 196.21391  73.05  4946
# 28   Shrubland        2 139.85748  71.00   936
# 29   Shrubland        3 139.45874  90.50   143
# 30   Shrubland        4  77.36000  79.40     5
# 31        Snow        1  56.46667  48.30     9
# 32        Snow        2 347.00000 171.20    10
# 33      Spruce        1 183.35000 142.40     6
# 34       Swamp        1 164.35455  81.50    33
# 35       Swamp        2 132.98000  70.40    15
# 36      Tundra        1 141.20876  64.10  6327
# 37      Tundra        2 144.37394  74.70  1869
# 38      Tundra        3 155.08300  58.40   253
# 39      Tundra        4  37.86000  24.40    10
# 40       Water        1 136.94788  84.70   165
# 41       Water        2  83.43571  58.35    28
# 42     Wetland        1 182.97015  75.60 14421
# 43     Wetland        2 187.67659  75.40  1803
# 44     Wetland        3 146.00741  73.90   135
# 45     Wetland        4  97.06190  78.30    21
# 46          WS        1 237.44518  85.20 13227
# 47          WS        2 207.15316  96.30  1742
# 48          WS        3 265.42879 126.40   132
# 49          WS        4  44.60000  44.60     1


# Keep only those levels that have at least 10 points
x.maxevt.gp.top <- x.maxevt.gp[x.maxevt.gp$n > 10, ]

# Keep only those classes that have at least 2 burn levels
x.maxevt.gp.top <- x.maxevt.gp.top[!(as.numeric(x.maxevt.gp.top$evt_group) %in% which(table(x.maxevt.gp.top$evt_group) < 2)), ]

```


```{r, echo = FALSE}

# --------------------------------- 
# Stats
# ---------------------------------

# Calculate 2-way ANOVA; evt group and burn num
x.anova <- aov(formula = frp ~ evt_group * burn_num, data = x.all)
summary(x.anova)
TukeyHSD(x.anova, which = "burn_num")
TukeyHSD(x.anova, which = "evt_group")


# Calculate anova: FRP vs year_int, evt, and burn_num
x.anova <- aov(formula = frp ~ year_int * as.factor(evt_group) * burn_num, data = subset(x.all, reburn > 0))
summary(x.anova)


# Save data and environment settings   
print(paste0("R data file saved to ", file.path(path.r, rdata)))
save.image(file = file.path(path.r, rdata))

# > x.maxevt.gp.top
# evt_group burn_num      mean    med     n
# 6  BirchAspen        1 275.93009 136.30  6929
# 7  BirchAspen        2 320.58424 187.10  1700
# 8  BirchAspen        3 454.13169 216.60   243
# 9  BirchAspen        4 545.50000 298.90    30
# 10  BlkSpruce        1 406.28216 185.80 11627
# 11  BlkSpruce        2 431.71630 228.90  1350
# 12  BlkSpruce        3 228.29524 131.50    21
# 13     Burned        1 120.75217  81.40    23
# 14     Burned        2 113.38966  62.10    29
# 15     Burned        3  84.79167  81.30    12
# 16 Floodplain        1 210.99758 103.20  3351
# 17 Floodplain        2 259.09631 129.10   731
# 18 Floodplain        3 217.75200  65.20    25
# 19  Grassland        1 416.55549 210.35   638
# 20  Grassland        2 270.20000 188.40    49
# 24   Peatland        1 160.21297  92.95  1072
# 25   Peatland        2 203.98716  71.10   109
# 26  Shrubland        1 261.68958 118.60  6238
# 27  Shrubland        2 204.79135 132.20  1271
# 28  Shrubland        3 207.54667 153.25   150
# 33      Swamp        1 141.90727  78.80    55
# 34      Swamp        2 136.20000  70.40    15
# 35     Tundra        1 214.86234 110.90  7275
# 36     Tundra        2 239.91687 128.40  2033
# 37     Tundra        3 227.70849 110.20   271
# 38     Tundra        4  53.79167  25.60    12
# 39      Water        1 172.32896 109.30   183
# 40      Water        2 240.95172 129.00    29
# 41    Wetland        1 291.45410 136.70 18006
# 42    Wetland        2 302.66308 158.50  2137
# 43    Wetland        3 309.50000 216.25   152
# 44    Wetland        4 381.13043 366.10    23
# 45  WhtSpruce        1 392.02319 185.80 14668
# 46  WhtSpruce        2 392.35054 201.30  1850
# 47  WhtSpruce        3 616.58309 389.80   136
# 

